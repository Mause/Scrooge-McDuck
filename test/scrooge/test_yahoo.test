# name: test/scrooge/test_yahoo.test
# description: Test Yahoo Finance Scanner
# group: [scrooge]

require scrooge

require httpfs

statement error
select * FROM yahoo_finance()

statement error
select * FROM yahoo_finance("^aeouhae", "2017-12-01"::DATE, "2017-12-10"::DATE, "1d")

statement error
select * FROM yahoo_finance("^GSPC", "2017-12-11"::DATE, "2017-12-10"::DATE, "1d")

statement error
select * FROM yahoo_finance("^GSPC", "2017-12-11"::DATE, "2017-12-10"::DATE, -1)

query IIIIIII
select * FROM yahoo_finance("^GSPC", "2017-12-01"::DATE, "2017-12-10"::DATE, "1d")
----
2017-12-01	2645.100098	2650.620117	2605.52002	2642.219971	2642.219971	3950930000
2017-12-04	2657.189941	2665.189941	2639.030029	2639.439941	2639.439941	4025840000
2017-12-05	2639.780029	2648.719971	2627.72998	2629.570068	2629.570068	3547570000
2017-12-06	2626.23999	2634.409912	2624.75	2629.27002	2629.27002	3253080000
2017-12-07	2628.379883	2640.98999	2626.530029	2636.97998	2636.97998	3297060000
2017-12-08	2646.209961	2651.649902	2644.100098	2651.5	2651.5	3126750000

# Try 5 day period
query IIIIIII
select * FROM yahoo_finance("^GSPC", "2017-12-01"::DATE, "2017-12-10"::DATE, "5d")
----
2017-12-01	2645.100098	2650.620117	2605.52002	2642.219971	2642.219971	3950930000
2017-12-06	2626.23999	2634.409912	2624.75	2629.27002	2629.27002	3253080000


# Try 1wk period
query IIIIIII
select * FROM yahoo_finance("^GSPC", "2017-12-01"::DATE, "2017-12-20"::DATE, "1wk")
----
2017-11-27	2633.929932	2657.73999	2605.52002	2642.219971	2642.219971	8916630000
2017-12-04	2657.189941	2665.189941	2624.75	2651.5	2651.5	17250300000
2017-12-11	2652.189941	2679.629883	2651.469971	2675.810059	2675.810059	19458420000
2017-12-18	2685.919922	2694.969971	2680.73999	2681.469971	2681.469971	7135450000


# Try 1mo period
query IIIIIII
select * FROM yahoo_finance("^GSPC", "2017-12-01"::DATE, "2018-06-20"::DATE, "1mo")
----
2017-12-01	2645.100098	2694.969971	2605.52002	2673.610107	2673.610107	65531700000
2018-01-01	2683.72998	2872.870117	2682.360107	2823.810059	2823.810059	77318690000
2018-02-01	2816.449951	2835.959961	2532.689941	2713.830078	2713.830078	79933970000
2018-03-01	2715.219971	2801.899902	2585.889893	2640.870117	2640.870117	76803890000
2018-04-01	2633.449951	2717.48999	2553.800049	2648.050049	2648.050049	70194700000
2018-05-01	2642.959961	2742.23999	2594.620117	2705.27002	2705.27002	76011820000
2018-06-01	2718.699951	2791.469971	2691.98999	2718.370117	2718.370117	77891360000

# Try 3mo period
query IIIIIII
select * FROM yahoo_finance("^GSPC", "2017-12-01"::DATE, "2018-06-20"::DATE, "3mo")
----
2017-12-01	2645.100098	2872.870117	2532.689941	2713.830078	2713.830078	222784360000
2018-03-01	2715.219971	2801.899902	2553.800049	2705.27002	2705.27002	223010410000
2018-06-01	2718.699951	2791.469971	2691.98999	2718.370117	2718.370117	77891360000

# Interval must be a string accepted by the yahoo api
statement error
select * FROM yahoo_finance("^GSPC", "2017-12-11"::DATE, "2017-12-12"::DATE, "bla")

# Periods can't be equal
statement error
select * FROM yahoo_finance("^GSPC", "2017-12-11"::DATE, "2017-12-11"::DATE, "1d")

# Interval can't be bigger than period
statement error
select * FROM yahoo_finance("^GSPC", "2017-12-11"::DATE, "2017-12-15"::DATE, "1mo")


# Start period must be castable to date
statement error
select * FROM yahoo_finance("^GSPC", "bla", "2017-12-15"::DATE, "1d")

# End period must be castable to date
statement error
select * FROM yahoo_finance("^GSPC", "2017-12-15"::DATE, "bla", "1d")

query I
select volatility(close) FROM yahoo_finance("^GSPC", "2017-12-01"::DATE, "2017-12-10"::DATE, "1d")
----
7.640770797901039

query I
select volatility(close) FROM yahoo_finance("^GSPC", "2017-12-01", "2017-12-10", "1d")
----
7.640770797901039

query I
select sma(close) FROM yahoo_finance("^GSPC", "2017-12-01"::DATE, "2017-12-10"::DATE, "1d")
----
2638.16333

query I
select volatility(close) FROM yahoo_finance("^GSPC", "2023-01-01"::DATE, "2023-02-18"::DATE, "1d")
----
101.31567537720929

query I
select volatility(close) FROM yahoo_finance("BTC-USD", "2023-01-01"::DATE, "2023-02-18"::DATE, "1d");
----
2491.094573465658